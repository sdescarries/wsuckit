<!DOCTYPE html>
<html>
<body id="main">
  <button type="button" onclick='ping()'>ping</button>
  <div id="output"></div>
</body>
<script>

const id = Date.now();

function send(socket, message) {

  if (socket.readyState !== 1) {
    console.warn('Socket not open');
  }

  console.log(`send ${message}`);
  socket.send(message);
}

function open(socket, _ev) {
  console.log(`open`);
  // send(socket, 'ping');
}

function close(socket, _ev) {
  console.log(`close`);
}

function message(socket, ev) {
  console.log(`recv ${ev.data}`);
  document.getElementById('output').innerHTML = ev.data;
  if (ev.data === 'pong') {
    // send(socket, 'close');
  }
}

function error(_socket, ev) {
  if (ev instanceof ErrorEvent) {
    console.log(`⚠️ ${ev.message}`);
  } else {
    console.log(`⚠️ ${ev.type}`);
  }
}

const url = new URL(document.location.href);

// url.pathname = '';
url.protocol = 'ws';

console.log(`Initiate WS on ${url.href}`);

const socket = new WebSocket(url.href);

socket.onopen = (ev) => open(socket, ev);
socket.onmessage = (ev) => message(socket, ev);
socket.onclose = (ev) => close(socket, ev);
socket.onerror = (ev) => error(socket, ev);

window.addEventListener('beforeunload', (event) => {
  event.preventDefault();
  send(socket, 'close');
});

const ping = () =>
  send(socket, 'ping');

</script>
</html>